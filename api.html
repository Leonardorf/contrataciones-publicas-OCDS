

<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Código fuente de la aplicación &mdash; documentación de Contrataciones Públicas de Mendoza (OCDS) - </title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=ba49ce02" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=e2bb6099"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=f85f4cfb"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Búsqueda" href="search.html" />
    <link rel="prev" title="Metodología" href="methodology.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Contrataciones Públicas de Mendoza (OCDS)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenido Principal:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introducción</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Uso</a><ul>
<li class="toctree-l2"><a class="reference internal" href="usage.html#github-codespaces">GitHub Codespaces</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="methodology.html">Metodología</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Código fuente de la aplicación</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Contrataciones Públicas de Mendoza (OCDS)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Código fuente de la aplicación</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/api.rst.txt" rel="nofollow"> Ver código fuente de la página</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="codigo-fuente-de-la-aplicacion">
<h1>Código fuente de la aplicación<a class="headerlink" href="#codigo-fuente-de-la-aplicacion" title="Link to this heading"></a></h1>
<p>Este módulo contiene la aplicación Dash principal y utilidades para cargar y
procesar datos OCDS. A continuación se incluye el código fuente con los
docstrings agregados para su lectura:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">  1</span><span class="c1"># Revertimos a la versión 0.1.4 manteniendo las mejoras en los tooltips</span>
</span><span class="linenos">  2</span><span class="kn">import</span><span class="w"> </span><span class="nn">dash</span>
<span class="linenos">  3</span><span class="kn">from</span><span class="w"> </span><span class="nn">dash</span><span class="w"> </span><span class="kn">import</span> <span class="n">dcc</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">dash_table</span>
<span class="linenos">  4</span><span class="kn">import</span><span class="w"> </span><span class="nn">dash_bootstrap_components</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dbc</span>
<span class="linenos">  5</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">  6</span><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="linenos">  7</span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">requests</span>
<span class="linenos">  8</span><span class="kn">import</span><span class="w"> </span><span class="nn">flask</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="c1"># Habilitar logs detallados para Flask</span>
<span class="linenos"> 11</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 12</span><span class="c1"># Configurar logs para que se muestren en la terminal</span>
<span class="linenos"> 13</span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()])</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos"> 16</span><span class="c1"># CONFIGURACIÓN BASE</span>
<span class="linenos"> 17</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos"> 18</span><span class="n">app</span> <span class="o">=</span> <span class="n">dash</span><span class="o">.</span><span class="n">Dash</span><span class="p">(</span>
<span class="linenos"> 19</span>    <span class="vm">__name__</span><span class="p">,</span>
<span class="linenos"> 20</span>    <span class="n">external_stylesheets</span><span class="o">=</span><span class="p">[</span><span class="n">dbc</span><span class="o">.</span><span class="n">themes</span><span class="o">.</span><span class="n">COSMO</span><span class="p">],</span>  <span class="c1"># Tema Bootstrap mejorado</span>
<span class="linenos"> 21</span>    <span class="n">suppress_callback_exceptions</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 22</span><span class="p">)</span>
<span class="linenos"> 23</span><span class="n">app</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Contrataciones Públicas de Mendoza (OCDS)&quot;</span>
<span class="linenos"> 24</span><span class="n">server</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">server</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="c1"># Configuración manual para servir archivos estáticos desde la carpeta &#39;assets&#39;</span>
<span class="linenos"> 27</span><span class="c1"># Agregar mensajes de depuración en la función para servir archivos estáticos</span>
<span class="linenos"> 28</span><span class="nd">@app</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/assets/&lt;path:path&gt;&#39;</span><span class="p">)</span>
<span class="linenos"> 29</span><span class="k">def</span><span class="w"> </span><span class="nf">serve_static_assets</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="linenos"> 30</span>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intentando servir archivo estático: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 31</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 32</span>        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">send_from_directory</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="linenos"> 33</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 34</span>        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al servir archivo estático: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 35</span>        <span class="k">raise</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="c1"># Ruta de prueba para servir un archivo específico</span>
<span class="linenos"> 38</span><span class="c1"># Actualizar la función para usar la ruta absoluta de la carpeta &#39;assets&#39;</span>
<span class="linenos"> 39</span><span class="nd">@app</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/test-file&#39;</span><span class="p">)</span>
<span class="linenos"> 40</span><span class="k">def</span><span class="w"> </span><span class="nf">serve_test_file</span><span class="p">():</span>
<span class="linenos"> 41</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 42</span>        <span class="n">ruta_absoluta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
<span class="linenos"> 43</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ruta absoluta de la carpeta &#39;assets&#39;: </span><span class="si">{</span><span class="n">ruta_absoluta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 44</span>        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">send_from_directory</span><span class="p">(</span><span class="n">ruta_absoluta</span><span class="p">,</span> <span class="s1">&#39;texto.txt&#39;</span><span class="p">)</span>
<span class="linenos"> 45</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 46</span>        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al servir archivo de prueba: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 47</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error al servir archivo de prueba: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">500</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="c1"># Agregar mensajes de depuración para el archivo &#39;marca_gov.png&#39;</span>
<span class="linenos"> 50</span><span class="nd">@app</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/test-image&#39;</span><span class="p">)</span>
<span class="linenos"> 51</span><span class="k">def</span><span class="w"> </span><span class="nf">serve_test_image</span><span class="p">():</span>
<span class="linenos"> 52</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 53</span>        <span class="n">ruta_absoluta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
<span class="linenos"> 54</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intentando servir &#39;marca_gov.png&#39; desde: </span><span class="si">{</span><span class="n">ruta_absoluta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 55</span>        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">send_from_directory</span><span class="p">(</span><span class="n">ruta_absoluta</span><span class="p">,</span> <span class="s1">&#39;marca_gov.png&#39;</span><span class="p">)</span>
<span class="linenos"> 56</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 57</span>        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al servir &#39;marca_gov.png&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 58</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error al servir &#39;marca_gov.png&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">500</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos"> 61</span><span class="c1"># FUNCIONES AUXILIARES</span>
<span class="linenos"> 62</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos"> 63</span><span class="k">def</span><span class="w"> </span><span class="nf">cargar_ocds</span><span class="p">(</span><span class="n">ruta</span><span class="p">):</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Carga un JSON OCDS desde una URL o desde una ruta local.</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="sd">    Parámetros</span>
<span class="linenos"> 67</span><span class="sd">    ----------</span>
<span class="linenos"> 68</span><span class="sd">    ruta : str</span>
<span class="linenos"> 69</span><span class="sd">        Ruta absoluta/relativa del archivo JSON o URL HTTP(S).</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="sd">    Retorna</span>
<span class="linenos"> 72</span><span class="sd">    -------</span>
<span class="linenos"> 73</span><span class="sd">    dict</span>
<span class="linenos"> 74</span><span class="sd">        Objeto Python con el contenido JSON del release OCDS.</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="sd">    Lanza</span>
<span class="linenos"> 77</span><span class="sd">    -----</span>
<span class="linenos"> 78</span><span class="sd">    ValueError</span>
<span class="linenos"> 79</span><span class="sd">        Si la ruta no es válida ni URL ni archivo existente.</span>
<span class="linenos"> 80</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 81</span>    <span class="k">if</span> <span class="n">ruta</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
<span class="linenos"> 82</span>        <span class="c1"># Añadimos timeout y un User-Agent para entornos con filtros</span>
<span class="linenos"> 83</span>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;OCDS-Mendoza-Dashboard/1.0&quot;</span><span class="p">}</span>
<span class="linenos"> 84</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ruta</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="linenos"> 85</span>        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="linenos"> 86</span>        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos"> 87</span>    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ruta</span><span class="p">):</span>
<span class="linenos"> 88</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ruta</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos"> 89</span>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos"> 90</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 91</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se reconoce la ruta: </span><span class="si">{</span><span class="n">ruta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="k">def</span><span class="w"> </span><span class="nf">extraer_contratos</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Transforma el JSON OCDS en un DataFrame tabular de contratos/adjudicaciones.</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="sd">    Recorre la lista de ``releases`` y normaliza campos relevantes para</span>
<span class="linenos"> 97</span><span class="sd">    análisis y visualización (fecha, tender_id, licitante, proveedor, monto,</span>
<span class="linenos"> 98</span><span class="sd">    tipo de contratación estimado, etc.).</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="sd">    Parámetros</span>
<span class="linenos">101</span><span class="sd">    ----------</span>
<span class="linenos">102</span><span class="sd">    data : dict</span>
<span class="linenos">103</span><span class="sd">        Estructura JSON con el/los releases en formato OCDS.</span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="sd">    Retorna</span>
<span class="linenos">106</span><span class="sd">    -------</span>
<span class="linenos">107</span><span class="sd">    pandas.DataFrame</span>
<span class="linenos">108</span><span class="sd">        Tabla con registros por proveedor/adjudicación.</span>
<span class="linenos">109</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">110</span>    <span class="n">registros</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">111</span>    <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;releases&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<span class="linenos">112</span>        <span class="n">fecha</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">113</span>            <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tender&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startDate&quot;</span><span class="p">)</span>
<span class="linenos">114</span>            <span class="ow">or</span> <span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">115</span>            <span class="ow">or</span> <span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contracts&quot;</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dateSigned&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contracts&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">116</span>            <span class="ow">or</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
<span class="linenos">117</span>        <span class="p">)</span>
<span class="linenos">118</span>        <span class="n">tender</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tender&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos">119</span>        <span class="n">buyer</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buyer&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos">120</span>        <span class="n">awards</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="linenos">121</span>        <span class="n">contracts</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contracts&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="linenos">122</span>
<span class="linenos">123</span>        <span class="c1"># Guardamos submissionMethodDetails si existe (ayuda a inferir tipo)</span>
<span class="linenos">124</span>        <span class="n">submission_details</span> <span class="o">=</span> <span class="n">tender</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submissionMethodDetails&quot;</span><span class="p">)</span>
<span class="linenos">125</span>
<span class="linenos">126</span>        <span class="n">tender_id</span> <span class="o">=</span> <span class="n">tender</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="linenos">127</span>        <span class="n">contrato_desc</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">128</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tender_id</span> <span class="ow">and</span> <span class="n">contracts</span><span class="p">:</span>
<span class="linenos">129</span>            <span class="n">desc</span> <span class="o">=</span> <span class="n">contracts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">130</span>            <span class="n">contrato_desc</span> <span class="o">=</span> <span class="n">desc</span>
<span class="linenos">131</span>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Proceso Nº ([0-9\-]+-[A-Z]+\d+)&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
<span class="linenos">132</span>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<span class="linenos">133</span>                <span class="n">tender_id</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">134</span>
<span class="linenos">135</span>        <span class="k">for</span> <span class="n">aw</span> <span class="ow">in</span> <span class="n">awards</span><span class="p">:</span>
<span class="linenos">136</span>            <span class="n">monto</span> <span class="o">=</span> <span class="n">aw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount&quot;</span><span class="p">)</span>
<span class="linenos">137</span>            <span class="n">moneda</span> <span class="o">=</span> <span class="n">aw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;currency&quot;</span><span class="p">)</span>
<span class="linenos">138</span>            <span class="n">suppliers</span> <span class="o">=</span> <span class="n">aw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suppliers&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="linenos">139</span>            <span class="k">if</span> <span class="n">suppliers</span><span class="p">:</span>
<span class="linenos">140</span>                <span class="k">for</span> <span class="n">sup</span> <span class="ow">in</span> <span class="n">suppliers</span><span class="p">:</span>
<span class="linenos">141</span>                    <span class="n">registros</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">142</span>                        <span class="s2">&quot;fecha&quot;</span><span class="p">:</span> <span class="n">fecha</span><span class="p">,</span>
<span class="linenos">143</span>                        <span class="s2">&quot;tender_id&quot;</span><span class="p">:</span> <span class="n">tender_id</span><span class="p">,</span>
<span class="linenos">144</span>                        <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="n">tender</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
<span class="linenos">145</span>                        <span class="s2">&quot;licitante&quot;</span><span class="p">:</span> <span class="n">buyer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
<span class="linenos">146</span>                        <span class="s2">&quot;proveedor&quot;</span><span class="p">:</span> <span class="n">sup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
<span class="linenos">147</span>                        <span class="s2">&quot;monto&quot;</span><span class="p">:</span> <span class="n">monto</span><span class="p">,</span>
<span class="linenos">148</span>                        <span class="s2">&quot;moneda&quot;</span><span class="p">:</span> <span class="n">moneda</span><span class="p">,</span>
<span class="linenos">149</span>                        <span class="s2">&quot;contracts&quot;</span><span class="p">:</span> <span class="n">contracts</span><span class="p">,</span>
<span class="linenos">150</span>                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">tender</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]),</span>
<span class="linenos">151</span>                        <span class="s2">&quot;contrato_desc&quot;</span><span class="p">:</span> <span class="n">contrato_desc</span><span class="p">,</span>
<span class="linenos">152</span>                        <span class="s2">&quot;submission_details&quot;</span><span class="p">:</span> <span class="n">submission_details</span><span class="p">,</span>
<span class="linenos">153</span>                        <span class="s2">&quot;awards&quot;</span><span class="p">:</span> <span class="n">awards</span>
<span class="linenos">154</span>                    <span class="p">})</span>
<span class="linenos">155</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">156</span>                <span class="n">registros</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">157</span>                    <span class="s2">&quot;fecha&quot;</span><span class="p">:</span> <span class="n">fecha</span><span class="p">,</span>
<span class="linenos">158</span>                    <span class="s2">&quot;tender_id&quot;</span><span class="p">:</span> <span class="n">tender_id</span><span class="p">,</span>
<span class="linenos">159</span>                    <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="n">tender</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
<span class="linenos">160</span>                    <span class="s2">&quot;licitante&quot;</span><span class="p">:</span> <span class="n">buyer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
<span class="linenos">161</span>                    <span class="s2">&quot;proveedor&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">162</span>                    <span class="s2">&quot;monto&quot;</span><span class="p">:</span> <span class="n">monto</span><span class="p">,</span>
<span class="linenos">163</span>                    <span class="s2">&quot;moneda&quot;</span><span class="p">:</span> <span class="n">moneda</span><span class="p">,</span>
<span class="linenos">164</span>                    <span class="s2">&quot;contracts&quot;</span><span class="p">:</span> <span class="n">contracts</span><span class="p">,</span>
<span class="linenos">165</span>                    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">tender</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]),</span>
<span class="linenos">166</span>                    <span class="s2">&quot;contrato_desc&quot;</span><span class="p">:</span> <span class="n">contrato_desc</span><span class="p">,</span>
<span class="linenos">167</span>                    <span class="s2">&quot;submission_details&quot;</span><span class="p">:</span> <span class="n">submission_details</span><span class="p">,</span>
<span class="linenos">168</span>                    <span class="s2">&quot;awards&quot;</span><span class="p">:</span> <span class="n">awards</span>
<span class="linenos">169</span>                <span class="p">})</span>
<span class="linenos">170</span>
<span class="linenos">171</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">registros</span><span class="p">)</span>
<span class="linenos">172</span>    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
<span class="linenos">173</span>    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<span class="linenos">174</span>    <span class="k">return</span> <span class="n">df</span>
<span class="linenos">175</span>
<span class="linenos">176</span><span class="k">def</span><span class="w"> </span><span class="nf">detectar_tipo</span><span class="p">(</span><span class="n">tender_id</span><span class="p">,</span> <span class="n">titulo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contrato_desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">submission_details</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">177</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Intenta clasificar el tipo de contratación.</span>
<span class="linenos">178</span>
<span class="linenos">179</span><span class="sd">    La heurística busca primero un sufijo en ``tender_id`` (p. ej. ``-LPU99``),</span>
<span class="linenos">180</span><span class="sd">    y si no está disponible, infiere desde ``titulo``, ``submission_details`` o</span>
<span class="linenos">181</span><span class="sd">    ``contrato_desc`` buscando palabras clave.</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="sd">    Parámetros</span>
<span class="linenos">184</span><span class="sd">    ----------</span>
<span class="linenos">185</span><span class="sd">    tender_id : str | None</span>
<span class="linenos">186</span><span class="sd">        Identificador del proceso licitatorio.</span>
<span class="linenos">187</span><span class="sd">    titulo : str | None</span>
<span class="linenos">188</span><span class="sd">        Título del proceso (si existe).</span>
<span class="linenos">189</span><span class="sd">    contrato_desc : str | None</span>
<span class="linenos">190</span><span class="sd">        Descripción de contrato (fallback).</span>
<span class="linenos">191</span><span class="sd">    submission_details : str | None</span>
<span class="linenos">192</span><span class="sd">        Texto con detalles del método de presentación (si existe).</span>
<span class="linenos">193</span>
<span class="linenos">194</span><span class="sd">    Retorna</span>
<span class="linenos">195</span><span class="sd">    -------</span>
<span class="linenos">196</span><span class="sd">    str</span>
<span class="linenos">197</span><span class="sd">        Uno de ``{&quot;LPU&quot;, &quot;CDI&quot;, &quot;Otro&quot;}``.</span>
<span class="linenos">198</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">199</span>    <span class="c1"># 1) desde tender_id</span>
<span class="linenos">200</span>    <span class="k">if</span> <span class="n">tender_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">tender_id</span><span class="p">):</span>
<span class="linenos">201</span>        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-([A-Z]{2,4})\d+$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tender_id</span><span class="p">))</span>
<span class="linenos">202</span>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
<span class="linenos">203</span>            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">204</span>
<span class="linenos">205</span>    <span class="c1"># 2) fallback desde texto del título / submission_details / contrato_desc</span>
<span class="linenos">206</span>    <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">titulo</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">submission_details</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">contrato_desc</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()]))</span>
<span class="linenos">207</span>    <span class="k">if</span> <span class="s2">&quot;contratación directa&quot;</span> <span class="ow">in</span> <span class="n">txt</span> <span class="ow">or</span> <span class="s2">&quot;contratacion directa&quot;</span> <span class="ow">in</span> <span class="n">txt</span> <span class="ow">or</span> <span class="s2">&quot;contratación-directa&quot;</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span>
<span class="linenos">208</span>        <span class="k">return</span> <span class="s2">&quot;CDI&quot;</span>
<span class="linenos">209</span>    <span class="k">if</span> <span class="s2">&quot;licitación pública&quot;</span> <span class="ow">in</span> <span class="n">txt</span> <span class="ow">or</span> <span class="s2">&quot;licitacion publica&quot;</span> <span class="ow">in</span> <span class="n">txt</span> <span class="ow">or</span> <span class="s2">&quot;licitacion pública&quot;</span> <span class="ow">in</span> <span class="n">txt</span> <span class="ow">or</span> <span class="s2">&quot;licitacion-publica&quot;</span> <span class="ow">in</span> <span class="n">txt</span> <span class="ow">or</span> <span class="s2">&quot;licitación-publica&quot;</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span>
<span class="linenos">210</span>        <span class="k">return</span> <span class="s2">&quot;LPU&quot;</span>
<span class="linenos">211</span>
<span class="linenos">212</span>    <span class="c1"># si no se detecta, devolver &quot;Otro&quot;</span>
<span class="linenos">213</span>    <span class="k">return</span> <span class="s2">&quot;Otro&quot;</span>
<span class="linenos">214</span>
<span class="linenos">215</span><span class="k">def</span><span class="w"> </span><span class="nf">format_mill_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="linenos">216</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Formatea números en millones para su uso en tablas.</span>
<span class="linenos">217</span>
<span class="linenos">218</span><span class="sd">    - Recibe un valor numérico que representa millones (p. ej. ``54137.6``).</span>
<span class="linenos">219</span><span class="sd">    - Redondea al entero (``54137``).</span>
<span class="linenos">220</span><span class="sd">    - Devuelve un texto con separador de miles ``.`` y sufijo ``M``</span>
<span class="linenos">221</span><span class="sd">      (``&quot;54.137M&quot;`` en el ejemplo).</span>
<span class="linenos">222</span>
<span class="linenos">223</span><span class="sd">    Parámetros</span>
<span class="linenos">224</span><span class="sd">    ----------</span>
<span class="linenos">225</span><span class="sd">    x : float | int | None</span>
<span class="linenos">226</span><span class="sd">        Valor numérico en millones.</span>
<span class="linenos">227</span>
<span class="linenos">228</span><span class="sd">    Retorna</span>
<span class="linenos">229</span><span class="sd">    -------</span>
<span class="linenos">230</span><span class="sd">    str</span>
<span class="linenos">231</span><span class="sd">        Cadena formateada o ``&quot;-&quot;`` si el valor no es válido.</span>
<span class="linenos">232</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">233</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">234</span>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="linenos">235</span>            <span class="k">return</span> <span class="s2">&quot;-&quot;</span>
<span class="linenos">236</span>        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="linenos">237</span>        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="linenos">238</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">M&quot;</span>
<span class="linenos">239</span>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">240</span>        <span class="k">return</span> <span class="s2">&quot;-&quot;</span>
<span class="linenos">241</span>
<span class="linenos">242</span><span class="k">def</span><span class="w"> </span><span class="nf">format_mill_hover</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="linenos">243</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Formatea valores en millones para tooltips (hover) en gráficos.</span>
<span class="linenos">244</span>
<span class="linenos">245</span><span class="sd">    Muestra el valor con ``decimals`` decimales y sufijo ``M``.</span>
<span class="linenos">246</span>
<span class="linenos">247</span><span class="sd">    Parámetros</span>
<span class="linenos">248</span><span class="sd">    ----------</span>
<span class="linenos">249</span><span class="sd">    x : float | int | None</span>
<span class="linenos">250</span><span class="sd">        Valor en millones.</span>
<span class="linenos">251</span><span class="sd">    decimals : int</span>
<span class="linenos">252</span><span class="sd">        Cantidad de decimales a mostrar (por defecto 3).</span>
<span class="linenos">253</span>
<span class="linenos">254</span><span class="sd">    Retorna</span>
<span class="linenos">255</span><span class="sd">    -------</span>
<span class="linenos">256</span><span class="sd">    str</span>
<span class="linenos">257</span><span class="sd">        Cadena formateada o ``&quot;-&quot;`` si el valor no es válido.</span>
<span class="linenos">258</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">259</span>    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="linenos">260</span>        <span class="k">return</span> <span class="s2">&quot;-&quot;</span>
<span class="linenos">261</span>    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">262</span>    <span class="c1"># mostramos con 3 decimales (ej: 54137.600) y añadimos &#39;M&#39;</span>
<span class="linenos">263</span>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">,.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;M&quot;</span>
<span class="linenos">264</span>
<span class="linenos">265</span><span class="c1"># Función para capitalizar títulos</span>
<span class="linenos">266</span><span class="k">def</span><span class="w"> </span><span class="nf">capitalize_title</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
<span class="linenos">267</span>    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="linenos">268</span>
<span class="linenos">269</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">270</span><span class="c1"># CARGA DE DATOS y normalizaciones</span>
<span class="linenos">271</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">272</span><span class="c1"># Fuente del dataset OCDS (URL o ruta local). Puede configurarse por variable de entorno</span>
<span class="linenos">273</span><span class="c1"># Ejemplo de URL oficial: https://datosabiertos-compras.mendoza.gov.ar/descargar-json/02/20250810_release.json</span>
<span class="linenos">274</span><span class="n">URL_JSON</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
<span class="linenos">275</span>    <span class="s2">&quot;OCDS_JSON_URL&quot;</span><span class="p">,</span>
<span class="linenos">276</span>    <span class="s2">&quot;https://datosabiertos-compras.mendoza.gov.ar/descargar-json/02/20250810_release.json&quot;</span><span class="p">,</span>
<span class="linenos">277</span><span class="p">)</span>
<span class="linenos">278</span><span class="n">data</span> <span class="o">=</span> <span class="n">cargar_ocds</span><span class="p">(</span><span class="n">URL_JSON</span><span class="p">)</span>
<span class="linenos">279</span><span class="n">df</span> <span class="o">=</span> <span class="n">extraer_contratos</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">280</span>
<span class="linenos">281</span><span class="c1"># Añadimos tipo (intento por tender_id, con fallback a título/descr)</span>
<span class="linenos">282</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<span class="linenos">283</span>    <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">detectar_tipo</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tender_id&quot;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;titulo&quot;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contrato_desc&quot;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submission_details&quot;</span><span class="p">)),</span>
<span class="linenos">284</span>    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="linenos">285</span><span class="p">)</span>
<span class="linenos">286</span>
<span class="linenos">287</span><span class="c1"># convertimos monto a float y creamos columna en millones (numérica)</span>
<span class="linenos">288</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;monto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;monto&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos">289</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;monto&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1_000_000.0</span>
<span class="linenos">290</span>
<span class="linenos">291</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">292</span><span class="c1"># ENCABEZADO CON ESCUDO</span>
<span class="linenos">293</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">294</span><span class="n">header</span> <span class="o">=</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Navbar</span><span class="p">(</span>
<span class="linenos">295</span>    <span class="n">dbc</span><span class="o">.</span><span class="n">Container</span><span class="p">([</span>
<span class="linenos">296</span>        <span class="n">html</span><span class="o">.</span><span class="n">A</span><span class="p">(</span>
<span class="linenos">297</span>            <span class="n">html</span><span class="o">.</span><span class="n">Img</span><span class="p">(</span>
<span class="linenos">298</span>                <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://mza-dicaws-portal-uploads-media-prod.s3.amazonaws.com/principal/uploads/2025/10/SITIO-AC_200x200-1-300x300-1.png&quot;</span><span class="p">,</span>
<span class="linenos">299</span>                <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;80px&quot;</span><span class="p">}</span>  <span class="c1"># Ajustamos el tamaño</span>
<span class="linenos">300</span>            <span class="p">),</span>
<span class="linenos">301</span>            <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://www.mendoza.gov.ar/compras/&quot;</span><span class="p">,</span>  <span class="c1"># Hipervínculo al escudo de gobierno</span>
<span class="linenos">302</span>            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;_blank&quot;</span>  <span class="c1"># Abrir en una nueva pestaña</span>
<span class="linenos">303</span>        <span class="p">),</span>
<span class="linenos">304</span>        <span class="n">html</span><span class="o">.</span><span class="n">H1</span><span class="p">([</span>
<span class="linenos">305</span>            <span class="s2">&quot;Contrataciones Públicas de Mendoza (OCDS)          &quot;</span><span class="p">,</span>
<span class="linenos">306</span>            <span class="n">html</span><span class="o">.</span><span class="n">A</span><span class="p">(</span>
<span class="linenos">307</span>                <span class="n">html</span><span class="o">.</span><span class="n">Img</span><span class="p">(</span>
<span class="linenos">308</span>                    <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://ocp.imgix.net/wp-content/uploads/2020/01/OCDS-logo-grey.png?auto=format&amp;w=1800&quot;</span><span class="p">,</span>
<span class="linenos">309</span>                    <span class="n">style</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">310</span>                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;50px&quot;</span><span class="p">,</span>
<span class="linenos">311</span>                        <span class="s2">&quot;marginLeft&quot;</span><span class="p">:</span> <span class="s2">&quot;100px&quot;</span><span class="p">,</span>
<span class="linenos">312</span>                        <span class="s2">&quot;backgroundColor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># Fondo blanco</span>
<span class="linenos">313</span>                        <span class="s2">&quot;padding&quot;</span><span class="p">:</span> <span class="s2">&quot;5px&quot;</span><span class="p">,</span>  <span class="c1"># Espaciado interno</span>
<span class="linenos">314</span>                        <span class="s2">&quot;borderRadius&quot;</span><span class="p">:</span> <span class="s2">&quot;5px&quot;</span>  <span class="c1"># Bordes redondeados</span>
<span class="linenos">315</span>                    <span class="p">}</span>
<span class="linenos">316</span>                <span class="p">),</span>
<span class="linenos">317</span>                <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://www.open-contracting.org/&quot;</span><span class="p">,</span>  <span class="c1"># Hipervínculo a Open Contracting</span>
<span class="linenos">318</span>                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;_blank&quot;</span>  <span class="c1"># Abrir en una nueva pestaña</span>
<span class="linenos">319</span>            <span class="p">)</span>
<span class="linenos">320</span>        <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-center text-white&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;marginLeft&quot;</span><span class="p">:</span> <span class="s2">&quot;-100%&quot;</span><span class="p">}),</span>  <span class="c1"># Ajustamos el margen para centrar mejor</span>
<span class="linenos">321</span>    <span class="p">]),</span>
<span class="linenos">322</span>    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dark&quot;</span><span class="p">,</span>
<span class="linenos">323</span>    <span class="n">dark</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">324</span>    <span class="n">className</span><span class="o">=</span><span class="s2">&quot;mb-4&quot;</span>
<span class="linenos">325</span><span class="p">)</span>
<span class="linenos">326</span>
<span class="linenos">327</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">328</span><span class="c1"># LAYOUT BASE</span>
<span class="linenos">329</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">330</span><span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Container</span><span class="p">([</span>
<span class="linenos">331</span>    <span class="n">header</span><span class="p">,</span>
<span class="linenos">332</span>    <span class="n">dbc</span><span class="o">.</span><span class="n">NavbarSimple</span><span class="p">(</span>
<span class="linenos">333</span>        <span class="n">children</span><span class="o">=</span><span class="p">[</span>
<span class="linenos">334</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">NavItem</span><span class="p">(</span><span class="n">dbc</span><span class="o">.</span><span class="n">NavLink</span><span class="p">(</span><span class="s2">&quot;🏠 Home&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)),</span>
<span class="linenos">335</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">NavItem</span><span class="p">(</span><span class="n">dbc</span><span class="o">.</span><span class="n">NavLink</span><span class="p">(</span><span class="s2">&quot;🏷️ Insumos&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/insumos&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)),</span>
<span class="linenos">336</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">NavItem</span><span class="p">(</span><span class="n">dbc</span><span class="o">.</span><span class="n">NavLink</span><span class="p">(</span><span class="s2">&quot;🔎 Procesos Filtrados&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/procesos&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)),</span>
<span class="linenos">337</span>        <span class="p">],</span>
<span class="linenos">338</span>        <span class="n">brand</span><span class="o">=</span><span class="p">[</span>
<span class="linenos">339</span>            <span class="s2">&quot;📊 Dashboard OCDS Mendoza&quot;</span><span class="p">,</span>
<span class="linenos">340</span>            <span class="n">html</span><span class="o">.</span><span class="n">Img</span><span class="p">(</span>
<span class="linenos">341</span>                <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://mza-dicaws-portal-uploads-media-prod.s3.amazonaws.com/principal/uploads/2025/10/SITIO-AC_200x200-1-300x300-1.png&quot;</span><span class="p">,</span>
<span class="linenos">342</span>                <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;50px&quot;</span><span class="p">,</span> <span class="s2">&quot;marginRight&quot;</span><span class="p">:</span> <span class="s2">&quot;10px&quot;</span><span class="p">}</span>  <span class="c1"># Ajustamos el tamaño y el margen</span>
<span class="linenos">343</span>            <span class="p">),</span>
<span class="linenos">344</span>            <span class="n">html</span><span class="o">.</span><span class="n">Img</span><span class="p">(</span>
<span class="linenos">345</span>                <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://ocp.imgix.net/wp-content/uploads/2020/01/OCDS-logo-grey.png?auto=format&amp;w=1800&quot;</span><span class="p">,</span>
<span class="linenos">346</span>                <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;50px&quot;</span><span class="p">,</span> <span class="s2">&quot;marginLeft&quot;</span><span class="p">:</span> <span class="s2">&quot;10px&quot;</span><span class="p">,</span> <span class="s2">&quot;backgroundColor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
<span class="linenos">347</span>                     
<span class="linenos">348</span>                    <span class="s2">&quot;borderRadius&quot;</span><span class="p">:</span> <span class="s2">&quot;5px&quot;</span>  <span class="p">}</span>  <span class="c1"># Ajustamos el tamaño y el margen</span>
<span class="linenos">349</span>            <span class="p">)</span>
<span class="linenos">350</span>        <span class="p">],</span>
<span class="linenos">351</span>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span>
<span class="linenos">352</span>        <span class="n">dark</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">353</span>        <span class="n">className</span><span class="o">=</span><span class="s2">&quot;mb-4&quot;</span>
<span class="linenos">354</span>    <span class="p">),</span>
<span class="linenos">355</span>    <span class="n">dcc</span><span class="o">.</span><span class="n">Location</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;url&quot;</span><span class="p">),</span>
<span class="linenos">356</span>    <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;page-content&quot;</span><span class="p">),</span>
<span class="linenos">357</span>    <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;Versión 0.1.5 – Dashboard OCDS Mendoza&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-muted small text-end&quot;</span><span class="p">)</span>
<span class="linenos">358</span><span class="p">],</span> <span class="n">fluid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">359</span>
<span class="linenos">360</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">361</span><span class="c1"># Página HOME</span>
<span class="linenos">362</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">363</span><span class="c1"># Restauramos la funcionalidad completa de layout_home con tablas y gráficos</span>
<span class="linenos">364</span><span class="k">def</span><span class="w"> </span><span class="nf">layout_home</span><span class="p">():</span>
<span class="linenos">365</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Genera el layout de la página principal (Home).</span>
<span class="linenos">366</span>
<span class="linenos">367</span><span class="sd">    Incluye un selector de año, tarjetas con totales y gráficos de evolución,</span>
<span class="linenos">368</span><span class="sd">    distribución por tipo de contratación y rankings de licitantes.</span>
<span class="linenos">369</span>
<span class="linenos">370</span><span class="sd">    Retorna</span>
<span class="linenos">371</span><span class="sd">    -------</span>
<span class="linenos">372</span><span class="sd">    dash.html.Div</span>
<span class="linenos">373</span><span class="sd">        Contenedor con los componentes Dash del layout Home.</span>
<span class="linenos">374</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">375</span>    <span class="n">años</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos">376</span>    <span class="n">año_sel</span> <span class="o">=</span> <span class="n">años</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">años</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">377</span>    <span class="n">rango</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fecha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fecha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">378</span>    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
<span class="linenos">379</span>        <span class="n">html</span><span class="o">.</span><span class="n">H5</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📅 Rango de fechas detectado en último Dataset publicado: </span><span class="si">{</span><span class="n">rango</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<span class="linenos">380</span>        <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span>
<span class="linenos">381</span>            <span class="s2">&quot;OCDS (Open Contracting Data Standard) es un estándar para publicar datos de contrataciones públicas &quot;</span>
<span class="linenos">382</span>            <span class="s2">&quot;en formato uniforme. Usarlo ayuda a comparar, analizar y auditar los procesos de compra pública.&quot;</span><span class="p">,</span>
<span class="linenos">383</span>            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontStyle&quot;</span><span class="p">:</span> <span class="s2">&quot;italic&quot;</span><span class="p">}</span>
<span class="linenos">384</span>        <span class="p">),</span>
<span class="linenos">385</span>        <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span>
<span class="linenos">386</span>            <span class="s2">&quot;Información correspondiente a los procesos de compras llevados a cabo por las diferentes reparticiones del Gobierno de la Provincia de Mendoza. &quot;</span>
<span class="linenos">387</span>            <span class="s2">&quot;Los datos corresponden a todos los bienes y servicios adquiridos por el Gobierno de la Provincia de Mendoza a través del sistema COMPRAR.&quot;</span><span class="p">,</span>
<span class="linenos">388</span>            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontStyle&quot;</span><span class="p">:</span> <span class="s2">&quot;italic&quot;</span><span class="p">}</span>
<span class="linenos">389</span>        <span class="p">),</span>
<span class="linenos">390</span>        <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
<span class="linenos">391</span>            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;año-selector-home&quot;</span><span class="p">,</span>
<span class="linenos">392</span>            <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">años</span><span class="p">],</span>
<span class="linenos">393</span>            <span class="n">value</span><span class="o">=</span><span class="n">año_sel</span><span class="p">,</span>
<span class="linenos">394</span>            <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">395</span>        <span class="p">),</span>
<span class="linenos">396</span>        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;contenido-home&quot;</span><span class="p">),</span>
<span class="linenos">397</span>        <span class="n">html</span><span class="o">.</span><span class="n">Hr</span><span class="p">(),</span>
<span class="linenos">398</span>    <span class="p">])</span>
<span class="linenos">399</span>
<span class="linenos">400</span><span class="c1"># Ajustamos los tooltips para eliminar los decimales en los montos</span>
<span class="linenos">401</span><span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">Output</span><span class="p">(</span><span class="s2">&quot;contenido-home&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span> <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;año-selector-home&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">))</span>
<span class="linenos">402</span><span class="k">def</span><span class="w"> </span><span class="nf">actualizar_home</span><span class="p">(</span><span class="n">año_sel</span><span class="p">):</span>
<span class="linenos">403</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback que actualiza el contenido de Home cuando cambia el año.</span>
<span class="linenos">404</span>
<span class="linenos">405</span><span class="sd">    Parámetros</span>
<span class="linenos">406</span><span class="sd">    ----------</span>
<span class="linenos">407</span><span class="sd">    año_sel : int</span>
<span class="linenos">408</span><span class="sd">        Año seleccionado en el ``Dropdown``.</span>
<span class="linenos">409</span>
<span class="linenos">410</span><span class="sd">    Retorna</span>
<span class="linenos">411</span><span class="sd">    -------</span>
<span class="linenos">412</span><span class="sd">    dash.html.Div</span>
<span class="linenos">413</span><span class="sd">        Componentes con tabla de totales y gráficos correspondientes.</span>
<span class="linenos">414</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">415</span>    <span class="k">if</span> <span class="n">año_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">416</span>        <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="s2">&quot;No hay datos disponibles.&quot;</span><span class="p">)</span>
<span class="linenos">417</span>    <span class="n">df_f</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">año_sel</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">418</span>
<span class="linenos">419</span>    <span class="c1"># --- Totales por tipo (numérico) y versión para mostrar formateada ---</span>
<span class="linenos">420</span>    <span class="n">totales</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="linenos">421</span>    <span class="n">totales</span><span class="p">[</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totales</span><span class="p">[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">format_mill_int</span><span class="p">)</span>
<span class="linenos">422</span>    <span class="n">totales_display</span> <span class="o">=</span> <span class="n">totales</span><span class="p">[[</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">,</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">:</span> <span class="s2">&quot;Tipo Contratación&quot;</span><span class="p">})</span>
<span class="linenos">423</span>
<span class="linenos">424</span>    <span class="n">tabla_totales</span> <span class="o">=</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span>
<span class="linenos">425</span>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tabla-totales&quot;</span><span class="p">,</span>
<span class="linenos">426</span>        <span class="n">columns</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">totales_display</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
<span class="linenos">427</span>        <span class="n">data</span><span class="o">=</span><span class="n">totales_display</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
<span class="linenos">428</span>        <span class="n">style_table</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;overflowX&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">},</span>
<span class="linenos">429</span>        <span class="n">page_size</span><span class="o">=</span><span class="mi">10</span>
<span class="linenos">430</span>    <span class="p">)</span>
<span class="linenos">431</span>
<span class="linenos">432</span>    <span class="c1"># --- Evolución mensual (gráfico) ---</span>
<span class="linenos">433</span>    <span class="n">df_mes</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">434</span>    <span class="n">df_mes</span><span class="p">[</span><span class="s2">&quot;mes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mes</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="linenos">435</span>    <span class="n">df_mes</span> <span class="o">=</span> <span class="n">df_mes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mes&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">total_monto</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">))</span>
<span class="linenos">436</span>
<span class="linenos">437</span>    <span class="n">fig_mes</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df_mes</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;mes&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;total_monto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">capitalize_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evolución mensual (</span><span class="si">{</span><span class="n">año_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
<span class="linenos">438</span>                      <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mes&quot;</span><span class="p">:</span> <span class="s2">&quot;Mes&quot;</span><span class="p">,</span> <span class="s2">&quot;total_monto&quot;</span><span class="p">:</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">})</span>
<span class="linenos">439</span>    <span class="n">fig_mes</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Mes=%</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Monto=%</span><span class="si">{y:.0f}</span><span class="s2">M&quot;</span><span class="p">)</span>
<span class="linenos">440</span>
<span class="linenos">441</span>    <span class="c1"># --- Monto por tipo de contratación (gráfico) ---</span>
<span class="linenos">442</span>    <span class="n">dist_tipo</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="linenos">443</span>    <span class="n">dist_tipo</span> <span class="o">=</span> <span class="n">dist_tipo</span><span class="p">[</span><span class="n">dist_tipo</span><span class="p">[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">444</span>    <span class="n">fig_pie</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">dist_tipo</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">capitalize_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monto por tipo de contratación (</span><span class="si">{</span><span class="n">año_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">))</span>
<span class="linenos">445</span>    <span class="n">fig_pie</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;%</span><span class="si">{label}</span><span class="s2">: %</span><span class="si">{value:.0f}</span><span class="s2">M&quot;</span><span class="p">)</span>
<span class="linenos">446</span>
<span class="linenos">447</span>    <span class="c1"># --- Top 10 licitantes (año) ---</span>
<span class="linenos">448</span>    <span class="n">top10</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;licitante&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;monto_millones&quot;</span><span class="p">)</span>
<span class="linenos">449</span>    <span class="n">fig_top10</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">top10</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;licitante&quot;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
<span class="linenos">450</span>                       <span class="n">title</span><span class="o">=</span><span class="n">capitalize_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top 10 Licitantes (</span><span class="si">{</span><span class="n">año_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
<span class="linenos">451</span>                       <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">:</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">,</span> <span class="s2">&quot;licitante&quot;</span><span class="p">:</span> <span class="s2">&quot;Licitante&quot;</span><span class="p">})</span>
<span class="linenos">452</span>    <span class="n">fig_top10</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Licitante=%</span><span class="si">{y}</span><span class="s2">&lt;br&gt;Monto=%</span><span class="si">{x:.0f}</span><span class="s2">M&quot;</span><span class="p">)</span>
<span class="linenos">453</span>
<span class="linenos">454</span>    <span class="c1"># --- Top 20 licitantes (total) ---</span>
<span class="linenos">455</span>    <span class="n">top20</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;licitante&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;monto_millones&quot;</span><span class="p">)</span>
<span class="linenos">456</span>    <span class="n">fig_top20</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">top20</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;licitante&quot;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
<span class="linenos">457</span>                       <span class="n">title</span><span class="o">=</span><span class="n">capitalize_title</span><span class="p">(</span><span class="s2">&quot;Top 20 Licitantes (Total)&quot;</span><span class="p">),</span>
<span class="linenos">458</span>                       <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">:</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">,</span> <span class="s2">&quot;licitante&quot;</span><span class="p">:</span> <span class="s2">&quot;Licitante&quot;</span><span class="p">})</span>
<span class="linenos">459</span>    <span class="n">fig_top20</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Licitante=%</span><span class="si">{y}</span><span class="s2">&lt;br&gt;Monto=%</span><span class="si">{x:.0f}</span><span class="s2">M&quot;</span><span class="p">)</span>
<span class="linenos">460</span>
<span class="linenos">461</span>    <span class="c1"># --- Top 30 montos (tabla) ---</span>
<span class="linenos">462</span>    <span class="n">top30</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;monto&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">463</span>    <span class="n">top30</span><span class="p">[</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top30</span><span class="p">[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">format_mill_int</span><span class="p">)</span>
<span class="linenos">464</span>    <span class="n">top30</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top30</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">465</span>    <span class="n">top30</span> <span class="o">=</span> <span class="n">top30</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tender_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Proceso&quot;</span><span class="p">,</span> <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="s2">&quot;Título&quot;</span><span class="p">,</span> <span class="s2">&quot;licitante&quot;</span><span class="p">:</span> <span class="s2">&quot;Licitante&quot;</span><span class="p">,</span> <span class="s2">&quot;proveedor&quot;</span><span class="p">:</span> <span class="s2">&quot;Proveedor&quot;</span><span class="p">})</span>
<span class="linenos">466</span>    <span class="n">cols_top30</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">,</span> <span class="s2">&quot;Proceso&quot;</span><span class="p">,</span> <span class="s2">&quot;Título&quot;</span><span class="p">,</span> <span class="s2">&quot;Licitante&quot;</span><span class="p">,</span> <span class="s2">&quot;Proveedor&quot;</span><span class="p">,</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span>
<span class="linenos">467</span>    <span class="n">tabla_top30</span> <span class="o">=</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span>
<span class="linenos">468</span>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tabla-top30&quot;</span><span class="p">,</span>
<span class="linenos">469</span>        <span class="n">columns</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols_top30</span><span class="p">],</span>
<span class="linenos">470</span>        <span class="n">data</span><span class="o">=</span><span class="n">top30</span><span class="p">[</span><span class="n">cols_top30</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
<span class="linenos">471</span>        <span class="n">style_table</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;overflowX&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">},</span>
<span class="linenos">472</span>        <span class="n">style_cell</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontSize&quot;</span><span class="p">:</span> <span class="s2">&quot;70%&quot;</span><span class="p">},</span>  <span class="c1"># Reducir el tamaño de la fuente al 70%</span>
<span class="linenos">473</span>        <span class="n">page_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="linenos">474</span>        <span class="n">sort_action</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">,</span>
<span class="linenos">475</span>    <span class="p">)</span>
<span class="linenos">476</span>
<span class="linenos">477</span>    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
<span class="linenos">478</span>        <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💰 Total Contratado Por Tipo De Contratación (</span><span class="si">{</span><span class="n">año_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
<span class="linenos">479</span>        <span class="n">tabla_totales</span><span class="p">,</span>
<span class="linenos">480</span>        <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">fig_mes</span><span class="p">),</span>
<span class="linenos">481</span>        <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">fig_pie</span><span class="p">),</span>
<span class="linenos">482</span>        <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">fig_top10</span><span class="p">),</span>
<span class="linenos">483</span>        <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">fig_top20</span><span class="p">),</span>
<span class="linenos">484</span>        <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏆 Top 30 Montos Más Altos (</span><span class="si">{</span><span class="n">año_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
<span class="linenos">485</span>        <span class="n">tabla_top30</span>
<span class="linenos">486</span>    <span class="p">])</span>
<span class="linenos">487</span>
<span class="linenos">488</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">489</span><span class="c1"># Página INSUMOS</span>
<span class="linenos">490</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">491</span><span class="k">def</span><span class="w"> </span><span class="nf">layout_insumos</span><span class="p">():</span>
<span class="linenos">492</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Genera el layout de la página de Insumos más contratados.</span>
<span class="linenos">493</span>
<span class="linenos">494</span><span class="sd">    Retorna</span>
<span class="linenos">495</span><span class="sd">    -------</span>
<span class="linenos">496</span><span class="sd">    dash.html.Div</span>
<span class="linenos">497</span><span class="sd">        Contenedor con el selector de año y el espacio para resultados.</span>
<span class="linenos">498</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">499</span>    <span class="n">años</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos">500</span>    <span class="n">año_sel</span> <span class="o">=</span> <span class="n">años</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">años</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">501</span>    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
<span class="linenos">502</span>        <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="s2">&quot;🏷️ Top Insumos Más Contratados&quot;</span><span class="p">),</span>
<span class="linenos">503</span>        <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
<span class="linenos">504</span>            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;año-selector-insumos&quot;</span><span class="p">,</span>
<span class="linenos">505</span>            <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">años</span><span class="p">],</span>
<span class="linenos">506</span>            <span class="n">value</span><span class="o">=</span><span class="n">año_sel</span><span class="p">,</span>
<span class="linenos">507</span>            <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">508</span>        <span class="p">),</span>
<span class="linenos">509</span>        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;contenido-insumos&quot;</span><span class="p">),</span>
<span class="linenos">510</span>        <span class="n">html</span><span class="o">.</span><span class="n">Hr</span><span class="p">()</span>
<span class="linenos">511</span>    <span class="p">])</span>
<span class="linenos">512</span>
<span class="linenos">513</span><span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">Output</span><span class="p">(</span><span class="s2">&quot;contenido-insumos&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span> <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;año-selector-insumos&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">))</span>
<span class="linenos">514</span><span class="k">def</span><span class="w"> </span><span class="nf">actualizar_insumos</span><span class="p">(</span><span class="n">año_sel</span><span class="p">):</span>
<span class="linenos">515</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback que arma el Top de insumos y su gráfico para el año dado.</span>
<span class="linenos">516</span>
<span class="linenos">517</span><span class="sd">    Parámetros</span>
<span class="linenos">518</span><span class="sd">    ----------</span>
<span class="linenos">519</span><span class="sd">    año_sel : int</span>
<span class="linenos">520</span><span class="sd">        Año seleccionado.</span>
<span class="linenos">521</span>
<span class="linenos">522</span><span class="sd">    Retorna</span>
<span class="linenos">523</span><span class="sd">    -------</span>
<span class="linenos">524</span><span class="sd">    dash.html.Div</span>
<span class="linenos">525</span><span class="sd">        Tabla y gráfico de barras con los insumos más contratados.</span>
<span class="linenos">526</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">527</span>    <span class="n">df_f</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">año_sel</span><span class="p">]</span>
<span class="linenos">528</span>    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">529</span>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_f</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="linenos">530</span>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<span class="linenos">531</span>            <span class="n">codigo</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;classification&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="linenos">532</span>            <span class="n">descripcion</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
<span class="linenos">533</span>            <span class="k">if</span> <span class="n">codigo</span> <span class="ow">and</span> <span class="n">descripcion</span><span class="p">:</span>
<span class="linenos">534</span>                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">535</span>                    <span class="s2">&quot;Código&quot;</span><span class="p">:</span> <span class="n">codigo</span><span class="p">,</span>
<span class="linenos">536</span>                    <span class="s2">&quot;Descripción corta&quot;</span><span class="p">:</span> <span class="n">descripcion</span><span class="p">[:</span><span class="mi">80</span><span class="p">],</span>
<span class="linenos">537</span>                    <span class="s2">&quot;Licitante&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;licitante&quot;</span><span class="p">),</span>
<span class="linenos">538</span>                    <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">539</span>                <span class="p">})</span>
<span class="linenos">540</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
<span class="linenos">541</span>        <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="s2">&quot;⚠️ No se encontraron items para este año.&quot;</span><span class="p">)</span>
<span class="linenos">542</span>    <span class="n">df_items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="linenos">543</span>    <span class="n">df_top</span> <span class="o">=</span> <span class="n">df_items</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Código&quot;</span><span class="p">,</span> <span class="s2">&quot;Descripción corta&quot;</span><span class="p">,</span> <span class="s2">&quot;Licitante&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="linenos">544</span>    <span class="n">df_top</span><span class="p">[</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_top</span><span class="p">[</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">format_mill_int</span><span class="p">)</span>
<span class="linenos">545</span>
<span class="linenos">546</span>    <span class="n">tabla</span> <span class="o">=</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span>
<span class="linenos">547</span>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tabla-insumos&quot;</span><span class="p">,</span>
<span class="linenos">548</span>        <span class="n">columns</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_top</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
<span class="linenos">549</span>        <span class="n">data</span><span class="o">=</span><span class="n">df_top</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
<span class="linenos">550</span>        <span class="n">style_table</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;overflowX&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">},</span>
<span class="linenos">551</span>        <span class="n">page_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="linenos">552</span>        <span class="n">sort_action</span><span class="o">=</span><span class="s2">&quot;native&quot;</span>
<span class="linenos">553</span>    <span class="p">)</span>
<span class="linenos">554</span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_top</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Descripción corta&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;Licitante&quot;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">capitalize_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top 30 Insumos Más Contratados (</span><span class="si">{</span><span class="n">año_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">))</span>
<span class="linenos">555</span>    <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Descripción=%</span><span class="si">{y}</span><span class="s2">&lt;br&gt;Monto=%</span><span class="si">{x}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">556</span>
<span class="linenos">557</span>    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span><span class="n">tabla</span><span class="p">,</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)])</span>
<span class="linenos">558</span>
<span class="linenos">559</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">560</span><span class="c1"># Página PROCESOS FILTRADOS (filtros y tabla)</span>
<span class="linenos">561</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">562</span><span class="k">def</span><span class="w"> </span><span class="nf">layout_procesos</span><span class="p">():</span>
<span class="linenos">563</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Genera el layout de la página de &quot;Procesos Filtrados&quot; con filtros.</span>
<span class="linenos">564</span>
<span class="linenos">565</span><span class="sd">    Retorna</span>
<span class="linenos">566</span><span class="sd">    -------</span>
<span class="linenos">567</span><span class="sd">    dash.html.Div</span>
<span class="linenos">568</span><span class="sd">        Contenedor con filtros y la tabla de resultados.</span>
<span class="linenos">569</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">570</span>    <span class="n">años</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos">571</span>    <span class="n">compradores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;licitante&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()])</span>
<span class="linenos">572</span>    <span class="n">proveedores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;proveedor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()])</span>
<span class="linenos">573</span>    <span class="n">tipos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()])</span>
<span class="linenos">574</span>
<span class="linenos">575</span>    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
<span class="linenos">576</span>        <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="s2">&quot;🔎 Procesos Filtrados&quot;</span><span class="p">),</span>
<span class="linenos">577</span>        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">([</span>
<span class="linenos">578</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;filtro-año&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">años</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">años</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">md</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">579</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;filtro-comprador&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compradores</span><span class="p">],</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Seleccionar comprador&quot;</span><span class="p">),</span> <span class="n">md</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">580</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;filtro-proveedor&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proveedores</span><span class="p">],</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Seleccionar proveedor&quot;</span><span class="p">),</span> <span class="n">md</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">581</span>            <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;filtro-tipo&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tipos</span><span class="p">],</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Seleccionar tipo&quot;</span><span class="p">),</span> <span class="n">md</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">582</span>        <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;mb-3&quot;</span><span class="p">),</span>
<span class="linenos">583</span>        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tabla-procesos&quot;</span><span class="p">),</span>
<span class="linenos">584</span>        <span class="n">html</span><span class="o">.</span><span class="n">Hr</span><span class="p">(),</span>
<span class="linenos">585</span>    <span class="p">])</span>
<span class="linenos">586</span>
<span class="linenos">587</span><span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
<span class="linenos">588</span>    <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;tabla-procesos&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span>
<span class="linenos">589</span>    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;filtro-año&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
<span class="linenos">590</span>    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;filtro-comprador&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
<span class="linenos">591</span>    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;filtro-proveedor&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
<span class="linenos">592</span>    <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;filtro-tipo&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="linenos">593</span><span class="p">)</span>
<span class="linenos">594</span><span class="k">def</span><span class="w"> </span><span class="nf">filtrar_procesos</span><span class="p">(</span><span class="n">año</span><span class="p">,</span> <span class="n">comprador</span><span class="p">,</span> <span class="n">proveedor</span><span class="p">,</span> <span class="n">tipo</span><span class="p">):</span>
<span class="linenos">595</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback que filtra procesos por año, comprador, proveedor y tipo.</span>
<span class="linenos">596</span>
<span class="linenos">597</span><span class="sd">    Parámetros</span>
<span class="linenos">598</span><span class="sd">    ----------</span>
<span class="linenos">599</span><span class="sd">    año : int</span>
<span class="linenos">600</span><span class="sd">        Año a filtrar.</span>
<span class="linenos">601</span><span class="sd">    comprador : str | None</span>
<span class="linenos">602</span><span class="sd">        Nombre del licitante (opcional).</span>
<span class="linenos">603</span><span class="sd">    proveedor : str | None</span>
<span class="linenos">604</span><span class="sd">        Nombre del proveedor (opcional).</span>
<span class="linenos">605</span><span class="sd">    tipo : str | None</span>
<span class="linenos">606</span><span class="sd">        Tipo de contratación, p. ej. ``&quot;LPU&quot;``, ``&quot;CDI&quot;`` (opcional).</span>
<span class="linenos">607</span>
<span class="linenos">608</span><span class="sd">    Retorna</span>
<span class="linenos">609</span><span class="sd">    -------</span>
<span class="linenos">610</span><span class="sd">    dash.dash_table.DataTable | dash.html.Div</span>
<span class="linenos">611</span><span class="sd">        Tabla con resultados o mensaje si no hay coincidencias.</span>
<span class="linenos">612</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">613</span>    <span class="n">df_f</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;año&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">año</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">614</span>    <span class="k">if</span> <span class="n">comprador</span><span class="p">:</span>
<span class="linenos">615</span>        <span class="n">df_f</span> <span class="o">=</span> <span class="n">df_f</span><span class="p">[</span><span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;licitante&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">comprador</span><span class="p">]</span>
<span class="linenos">616</span>    <span class="k">if</span> <span class="n">proveedor</span><span class="p">:</span>
<span class="linenos">617</span>        <span class="n">df_f</span> <span class="o">=</span> <span class="n">df_f</span><span class="p">[</span><span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;proveedor&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">proveedor</span><span class="p">]</span>
<span class="linenos">618</span>    <span class="k">if</span> <span class="n">tipo</span><span class="p">:</span>
<span class="linenos">619</span>        <span class="n">df_f</span> <span class="o">=</span> <span class="n">df_f</span><span class="p">[</span><span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;tipo_contratacion&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tipo</span><span class="p">]</span>
<span class="linenos">620</span>
<span class="linenos">621</span>    <span class="k">if</span> <span class="n">df_f</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<span class="linenos">622</span>        <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="s2">&quot;⚠️ No se encontraron procesos con esos filtros.&quot;</span><span class="p">)</span>
<span class="linenos">623</span>
<span class="linenos">624</span>    <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">625</span>    <span class="c1"># Ajustamos la lógica para buscar el award correspondiente al proveedor y luego el contrato</span>
<span class="linenos">626</span>    <span class="k">def</span><span class="w"> </span><span class="nf">obtener_orden_compra</span><span class="p">(</span><span class="n">awards</span><span class="p">,</span> <span class="n">contracts</span><span class="p">,</span> <span class="n">proveedor</span><span class="p">):</span>
<span class="linenos">627</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">awards</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">contracts</span><span class="p">:</span>
<span class="linenos">628</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">629</span>        <span class="c1"># Buscar el award que coincida con el proveedor</span>
<span class="linenos">630</span>        <span class="k">for</span> <span class="n">award</span> <span class="ow">in</span> <span class="n">awards</span><span class="p">:</span>
<span class="linenos">631</span>            <span class="k">if</span> <span class="n">award</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suppliers&quot;</span><span class="p">):</span>
<span class="linenos">632</span>                <span class="k">for</span> <span class="n">supplier</span> <span class="ow">in</span> <span class="n">award</span><span class="p">[</span><span class="s2">&quot;suppliers&quot;</span><span class="p">]:</span>
<span class="linenos">633</span>                    <span class="k">if</span> <span class="n">supplier</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">proveedor</span><span class="p">:</span>
<span class="linenos">634</span>                        <span class="c1"># Buscar el contrato correspondiente al award</span>
<span class="linenos">635</span>                        <span class="n">award_id</span> <span class="o">=</span> <span class="n">award</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="linenos">636</span>                        <span class="k">for</span> <span class="n">contract</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">:</span>
<span class="linenos">637</span>                            <span class="k">if</span> <span class="n">contract</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;awardID&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">award_id</span><span class="p">:</span>
<span class="linenos">638</span>                                <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="linenos">639</span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">640</span>
<span class="linenos">641</span>    <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;Orden de Compra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">obtener_orden_compra</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">),</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contracts&quot;</span><span class="p">),</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proveedor&quot;</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">642</span>
<span class="linenos">643</span>    <span class="c1"># columna Proceso (tender_id), y formateamos monto para mostrar</span>
<span class="linenos">644</span>    <span class="n">df_f</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tender_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Proceso&quot;</span><span class="p">,</span> <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="s2">&quot;Título&quot;</span><span class="p">})</span>
<span class="linenos">645</span>    <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">format_mill_int</span><span class="p">)</span>
<span class="linenos">646</span>
<span class="linenos">647</span>    <span class="c1"># Añadimos una columna auxiliar para el ordenamiento correcto</span>
<span class="linenos">648</span>    <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;Monto (Millones) Orden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f</span><span class="p">[</span><span class="s2">&quot;monto_millones&quot;</span><span class="p">]</span>
<span class="linenos">649</span>
<span class="linenos">650</span>    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fecha&quot;</span><span class="p">,</span> <span class="s2">&quot;Proceso&quot;</span><span class="p">,</span> <span class="s2">&quot;Título&quot;</span><span class="p">,</span> <span class="s2">&quot;licitante&quot;</span><span class="p">,</span> <span class="s2">&quot;proveedor&quot;</span><span class="p">,</span> <span class="s2">&quot;Orden de Compra&quot;</span><span class="p">,</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">]</span>
<span class="linenos">651</span>    <span class="c1"># títulos de columnas con capitalización y espacio</span>
<span class="linenos">652</span>    <span class="n">columns_out</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">653</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Fecha&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;fecha&quot;</span><span class="p">},</span>
<span class="linenos">654</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Proceso&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Proceso&quot;</span><span class="p">},</span>
<span class="linenos">655</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Título&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Título&quot;</span><span class="p">},</span>
<span class="linenos">656</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Licitante&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;licitante&quot;</span><span class="p">},</span>
<span class="linenos">657</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Proveedor&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;proveedor&quot;</span><span class="p">},</span>
<span class="linenos">658</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Orden de Compra&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Orden de Compra&quot;</span><span class="p">},</span>
<span class="linenos">659</span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Monto (Millones)&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;numeric&quot;</span><span class="p">}</span>
<span class="linenos">660</span>    <span class="p">]</span>
<span class="linenos">661</span>
<span class="linenos">662</span>    <span class="c1"># Incluimos la columna auxiliar en los datos pero no en las columnas visibles</span>
<span class="linenos">663</span>    <span class="n">tabla</span> <span class="o">=</span> <span class="n">dash_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span>
<span class="linenos">664</span>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tabla-procesos-filter&quot;</span><span class="p">,</span>
<span class="linenos">665</span>        <span class="n">columns</span><span class="o">=</span><span class="n">columns_out</span><span class="p">,</span>  <span class="c1"># Solo las columnas visibles</span>
<span class="linenos">666</span>        <span class="n">data</span><span class="o">=</span><span class="n">df_f</span><span class="p">[</span><span class="n">cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Monto (Millones) Orden&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>  <span class="c1"># Incluimos la columna auxiliar</span>
<span class="linenos">667</span>        <span class="n">style_table</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;overflowX&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">},</span>
<span class="linenos">668</span>        <span class="n">style_cell</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontSize&quot;</span><span class="p">:</span> <span class="s2">&quot;70%&quot;</span><span class="p">},</span>  <span class="c1"># Reducir el tamaño de la fuente al 70%</span>
<span class="linenos">669</span>        <span class="n">page_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="linenos">670</span>        <span class="n">sort_action</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">,</span>
<span class="linenos">671</span>        <span class="n">sort_mode</span><span class="o">=</span><span class="s2">&quot;multi&quot;</span>
<span class="linenos">672</span>    <span class="p">)</span>
<span class="linenos">673</span>    <span class="k">return</span> <span class="n">tabla</span>
<span class="linenos">674</span>
<span class="linenos">675</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">676</span><span class="c1"># RUTAS</span>
<span class="linenos">677</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">678</span><span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">Output</span><span class="p">(</span><span class="s2">&quot;page-content&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span> <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;pathname&quot;</span><span class="p">))</span>
<span class="linenos">679</span><span class="k">def</span><span class="w"> </span><span class="nf">mostrar_pagina</span><span class="p">(</span><span class="n">pathname</span><span class="p">):</span>
<span class="linenos">680</span>    <span class="k">if</span> <span class="n">pathname</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
<span class="linenos">681</span>        <span class="k">return</span> <span class="n">layout_home</span><span class="p">()</span>
<span class="linenos">682</span>    <span class="k">elif</span> <span class="n">pathname</span> <span class="o">==</span> <span class="s2">&quot;/insumos&quot;</span><span class="p">:</span>
<span class="linenos">683</span>        <span class="k">return</span> <span class="n">layout_insumos</span><span class="p">()</span>
<span class="linenos">684</span>    <span class="k">elif</span> <span class="n">pathname</span> <span class="o">==</span> <span class="s2">&quot;/procesos&quot;</span><span class="p">:</span>
<span class="linenos">685</span>        <span class="k">return</span> <span class="n">layout_procesos</span><span class="p">()</span>
<span class="linenos">686</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">687</span>        <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="s2">&quot;Página no encontrada.&quot;</span><span class="p">)</span>
<span class="linenos">688</span>
<span class="linenos">689</span><span class="c1"># ------------------------------------------------------</span>
<span class="linenos">690</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">691</span>    <span class="c1"># Permitir configurar host/port por entorno (útil para Codespaces/Paas)</span>
<span class="linenos">692</span>    <span class="n">host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>
<span class="linenos">693</span>    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;8050&quot;</span><span class="p">))</span>
<span class="linenos">694</span>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pie de página">
        <a href="methodology.html" class="btn btn-neutral float-left" title="Metodología" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor 2025, Ing. Leonardo Villegas.</p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>